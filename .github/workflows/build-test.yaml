name: PEZ-ServerMonitor Build and Test Action

on:
  - push

jobs:
  build-and-test:
    environment:
      name: production
    runs-on: ubuntu-latest
    name: Build and Test
    # env:
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10.12'

      - name: Install poetry
        shell: bash
        run: |
          python -m pip install poetry==1.4.0

      - name: Configure poetry
        shell: bash
        run: |
          python -m poetry config virtualenvs.in-project true

      - name: Cache the virtualenv
        uses: actions/cache@v3
        with:
          path: ./.venv
          key: ${{ runner.os }}-venv-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        shell: bash
        run: |
          python -m poetry install --no-root

      # - name: Code quality checks
      #   shell: bash
      #   run: |
      #     poetry run python -m black --check .

      - name: Run unit tests
        shell: bash
        run: |
          poetry run python -m pytest -xvvv tests/

      - name: Test run the tool
        if: success()
        shell: bash
        run: |
          cd src/
          poetry run python main.py -a
